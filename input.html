<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¬¸ì œ ì…ë ¥ í˜ì´ì§€</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .question-block {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    .choice-item { margin: 8px 0; }
    input[type="text"], textarea {
      padding: 6px;
      width: 90%;
      margin-top: 4px;
      margin-bottom: 4px;
    }
    textarea { height: 60px; resize: vertical; }
    button { margin-top: 10px; padding: 6px 10px; }
  </style>
</head>
<body>
<h1>ë¬¸ì œ ì…ë ¥ í˜ì´ì§€</h1>

<label>ìƒˆ ìœ í˜• ì¶”ê°€: <input type="text" id="new-type" placeholder="ì˜ˆ: ìë£Œêµ¬ì¡°" /></label>
<button onclick="addType()">+ ìœ í˜• ì¶”ê°€</button>
<br><br>

<label>ìœ í˜• ì„ íƒ: 
  <select id="type-select">
    <option value="">ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</option>
  </select>
</label>
<br><br>

<div id="questions-container"></div>
<button onclick="addQuestion()">+ ë¬¸ì œ ì¶”ê°€</button>
<button onclick="saveToFirebase()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDeERFKLaqDrczzNiqsIPfGcUoaEchBz4o",
    authDomain: "quiz-82fe2.firebaseapp.com",
    projectId: "quiz-82fe2",
    storageBucket: "quiz-82fe2.firebasestorage.app",
    messagingSenderId: "74793318423",
    appId: "1:74793318423:web:8ae9b229d41f0b4a080452"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let questionCount = 0;

  async function loadTypes() {
    const select = document.getElementById('type-select');
    select.innerHTML = '<option value="">ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    const snapshot = await getDocs(collection(db, "questionTypes"));
    snapshot.forEach(doc => {
      const option = document.createElement("option");
      option.value = doc.id;
      option.textContent = doc.id;
      select.appendChild(option);
    });
  }

  window.addType = async function () {
    const newType = document.getElementById('new-type').value.trim();
    if (!newType) return alert("ìœ í˜• ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");

    const docRef = doc(db, "questionTypes", newType);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìœ í˜•ì…ë‹ˆë‹¤.");

    await setDoc(docRef, { questions: [] });
    alert("ìœ í˜•ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
    document.getElementById('new-type').value = "";
    loadTypes();
  };

  window.addQuestion = function () {
    const container = document.getElementById('questions-container');
    const questionId = `question-${questionCount++}`;
    const div = document.createElement('div');
    div.className = 'question-block';
    div.id = questionId;

    // ë¬¸ì œ ìœ í˜• ì„ íƒ
    const questionTypeSelect = `
      <label>ë¬¸ì œ ìœ í˜•:
        <select class="question-type">
          <option value="multiple">ê°ê´€ì‹</option>
          <option value="short">ë‹¨ë‹µí˜•</option>
          <option value="ox">O/X</option>
        </select>
      </label><br><br>
    `;

    // ê°ê´€ì‹ ë³´ê¸° HTML
    let choicesHTML = '';
    for (let i = 0; i < 4; i++) {
      choicesHTML += `
        <div class="choice-item">
          <input type="checkbox" class="correct-checkbox" />
          <input type="text" class="choice-text" placeholder="ë³´ê¸° ì…ë ¥" />
          <button onclick="this.parentElement.remove()">âŒ</button>
        </div>
      `;
    }

    // ë‹¨ë‹µí˜• ì •ë‹µ ì…ë ¥
    const shortAnswerHTML = `
      <div class="short-answer-container" style="display: none;">
        <label>ì •ë‹µ: <input type="text" class="short-answer" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" /></label><br><br>
      </div>
    `;

    // O/X ì •ë‹µ ì„ íƒ
    const oxAnswerHTML = `
      <div class="ox-answer-container" style="display: none;">
        <label>ì •ë‹µ:
          <select class="ox-answer">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="O">O (ë§ìŒ)</option>
            <option value="X">X (í‹€ë¦¼)</option>
          </select>
        </label><br><br>
      </div>
    `;

    div.innerHTML = `
      ${questionTypeSelect}
      <label>ë¬¸ì œ: <br><textarea class="question-text" placeholder="ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea></label><br>
      <div class="choices-container">
        ${choicesHTML}
      </div>
      <button onclick="addChoice('${questionId}')" class="add-choice-btn">+ ë³´ê¸° ì¶”ê°€</button><br><br>
      ${shortAnswerHTML}
      ${oxAnswerHTML}
      <label>í’€ì´/ì„¤ëª…:<br><textarea class="explanation-text" placeholder="ì´ ë¬¸ì œì˜ í•´ì„¤ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea></label><br>
      <button onclick="deleteQuestion('${questionId}')">ğŸ—‘ï¸ ë¬¸ì œ ì‚­ì œ</button>
      <hr>
    `;

    // ë¬¸ì œ ìœ í˜• ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    const typeSelect = div.querySelector('.question-type');
    typeSelect.addEventListener('change', function() {
      const choicesContainer = div.querySelector('.choices-container');
      const addChoiceBtn = div.querySelector('.add-choice-btn');
      const shortAnswerContainer = div.querySelector('.short-answer-container');
      const oxAnswerContainer = div.querySelector('.ox-answer-container');

      if (this.value === 'multiple') {
        choicesContainer.style.display = 'block';
        addChoiceBtn.style.display = 'inline-block';
        shortAnswerContainer.style.display = 'none';
        oxAnswerContainer.style.display = 'none';
      } else if (this.value === 'short') {
        choicesContainer.style.display = 'none';
        addChoiceBtn.style.display = 'none';
        shortAnswerContainer.style.display = 'block';
        oxAnswerContainer.style.display = 'none';
      } else if (this.value === 'ox') {
        choicesContainer.style.display = 'none';
        addChoiceBtn.style.display = 'none';
        shortAnswerContainer.style.display = 'none';
        oxAnswerContainer.style.display = 'block';
      }
    });

    container.appendChild(div);
  };

  window.addChoice = function (questionId) {
    const container = document.querySelector(`#${questionId} .choices-container`);
    const choiceDiv = document.createElement('div');
    choiceDiv.className = 'choice-item';
    choiceDiv.innerHTML = `
      <input type="checkbox" class="correct-checkbox" />
      <input type="text" class="choice-text" placeholder="ë³´ê¸° ì…ë ¥" />
      <button onclick="this.parentElement.remove()">âŒ</button>
    `;
    container.appendChild(choiceDiv);
  };

  window.deleteQuestion = function (questionId) {
    const block = document.getElementById(questionId);
    if (block && confirm("ì •ë§ ì´ ë¬¸ì œë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
      block.remove();
    }
  };

  window.saveToFirebase = async function () {
    const selectedType = document.getElementById('type-select').value;
    if (!selectedType) return alert("ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");

    const questions = [];
    const questionBlocks = document.querySelectorAll('.question-block');

    questionBlocks.forEach(block => {
      const questionText = block.querySelector('.question-text').value.trim();
      const explanation = block.querySelector('.explanation-text').value.trim();
      const questionType = block.querySelector('.question-type').value;

      if (!questionText) return;

      if (questionType === 'multiple') {
        // ê°ê´€ì‹ ë¬¸ì œ
        const choiceElements = block.querySelectorAll('.choice-text');
        const correctCheckboxes = block.querySelectorAll('.correct-checkbox');

        const choices = [];
        const correctAnswers = [];

        choiceElements.forEach((choiceEl, idx) => {
          const text = choiceEl.value.trim();
          if (text) {
            choices.push(text);
            if (correctCheckboxes[idx].checked) {
              correctAnswers.push(idx);
            }
          }
        });

        if (choices.length > 0) {
          questions.push({ 
            question: questionText, 
            choices, 
            correctAnswers, 
            explanation, 
            type: 'multiple' 
          });
        }
      } else if (questionType === 'short') {
        // ë‹¨ë‹µí˜• ë¬¸ì œ
        const shortAnswer = block.querySelector('.short-answer').value.trim();
        if (shortAnswer) {
          questions.push({ 
            question: questionText, 
            answer: shortAnswer, 
            explanation, 
            type: 'short' 
          });
        }
      } else if (questionType === 'ox') {
        // O/X ë¬¸ì œ
        const oxAnswer = block.querySelector('.ox-answer').value;
        if (oxAnswer) {
          questions.push({ 
            question: questionText, 
            answer: oxAnswer, 
            explanation, 
            type: 'ox' 
          });
        }
      }
    });

    if (questions.length === 0) {
      alert("ìµœì†Œ 1ê°œì˜ ë¬¸ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const docRef = doc(db, "questionTypes", selectedType);
    const existing = await getDoc(docRef);
    const existingQuestions = existing.exists() ? existing.data().questions : [];
    await updateDoc(docRef, { questions: [...existingQuestions, ...questions] });
    alert("ğŸ”¥ Firebaseì— ë¬¸ì œ ì¶”ê°€ ì™„ë£Œ!");
    document.getElementById('questions-container').innerHTML = '';
  };

  loadTypes();
</script>
</body>
</html>
